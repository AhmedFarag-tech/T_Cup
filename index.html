<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tcup - تجربة دردشة (صوت حقيقي)</title>
    
    <script>
        // Load theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('Tcup-theme');
            if (savedTheme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>
    
    <style>
        :root {
            /* (الوضع المظلم الافتراضي) */
            --bg: #0f1724;
            --panel: #0b1220;
            --muted: #94a3b8;
            --accent: #06b6d4;
            --bubble: #1e293b;
            --me: #0ea5a3;
            --glass: rgba(255, 255, 255, 0.04);
            --radius: 12px;
            --shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
            --font-family: 'Segoe UI', Roboto, 'Noto Kufi Arabic', Tahoma, sans-serif;
        }

        html.light-mode {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --muted: #667781;
            --accent: #00a884; 
            --bubble: #ffffff;
            --me: #d9fdd3; 
            --glass: rgba(0, 0, 0, 0.04);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: linear-gradient(180deg, var(--bg), var(--bg));
            color: #e6eef3;
            font-family: var(--font-family);
            overflow: hidden; 
            transition: background 0.3s, color 0.3s;
        }
        
        html.light-mode,
        html.light-mode body {
            color: #111b21; 
        }
        html.light-mode .bubble.me {
            color: #111b21; 
        }
        html.light-mode .search input,
        html.light-mode .input-area textarea {
            color: #111b21;
        }
        html.light-mode .contact:hover, 
        html.light-mode .contact.active {
            background: rgba(0, 0, 0, 0.05);
        }
        html.light-mode .search button {
            color: #fff; 
        }
        html.light-mode .voice-bubble audio {
            filter: none; 
        }
        html.light-mode .btn-speed {
             color: var(--muted);
        }
        html.light-mode .btn-speed:hover {
            color: #fff;
        }
        html.light-mode .btn-icon svg {
            fill: #54656f; 
        }
        html.light-mode .btn-icon#sendBtn svg,
        html.light-mode #recording-ui .btn-icon#sendRecBtn svg {
             fill: var(--accent); 
        }
        html.light-mode .btn-icon.btn-danger svg {
             fill: white; 
        }


        /* ====== تعديل: التصميم الأساسي الآن للهاتف (Mobile-First) ====== */
        .app {
            width: 100%;
            height: 100%; /* Fallback */
            height: 100svh; /* الحل: استخدام Small Viewport Height */
            margin: 0;
            display: grid;
            grid-template-columns: 1fr; /* Mobile default */
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            transition: all 0.3s ease;
        }

        /* ====== جديد: تنسيق سطح المكتب ====== */
        @media(min-width: 901px) {
            .app {
                max-width: 1100px;
                margin: 20px auto;
                height: 86vh; /* الارتفاع القديم لسطح المكتب */
                grid-template-columns: 320px 1fr;
                border-radius: 16px;
                box-shadow: var(--shadow);
            }
        }
        /* ============================================== */


        /* LEFT: contacts */
        .sidebar {
            background: linear-gradient(180deg, var(--panel), var(--panel)); 
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: background 0.3s;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
        }

        .brand h1 {
            font-size: 20px;
            margin: 0;
        }

        .search {
            display: flex;
            gap: 8px;
        }

        .search input {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: 0;
            background: var(--glass);
            color: inherit;
            font-family: var(--font-family);
        }

        .search button {
            padding: 10px;
            border-radius: 10px;
            border: 0;
            background: var(--accent);
            color: #012;
            cursor: pointer;
            font-weight: bold;
        }

        .contacts {
            overflow: auto;
            padding-right: 6px;
        }

        .contact {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
        }

        .contact:hover, .contact.active {
            background: rgba(255, 255, 255, 0.05);
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(45deg, #334155, #0ea5a3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .meta {
            flex: 1;
            overflow: hidden;
        }

        .meta .name {
            font-weight: 600;
        }

        .meta .last {
            color: var(--muted);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* RIGHT: chat */
        .chat {
            background: linear-gradient(180deg, var(--bg), var(--bg)); 
            display: flex;
            flex-direction: column;
            transition: background 0.3s;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-bottom: 1px solid var(--glass); 
            flex-shrink: 0;
            background: var(--panel); 
        }
        
        .btn-back {
            display: none;
            background: none;
        }

        .chat-main {
            flex: 1;
            overflow: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .messages {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 760px;
            width: 100%;
            margin: 0 auto;
        }

        .bubble {
            padding: 10px 14px;
            border-radius: 14px;
            max-width: 70%;
            background: var(--bubble);
            box-shadow: var(--shadow);
            word-wrap: break-word;
        }

        .bubble.me {
            margin-left: auto;
            background: linear-gradient(135deg, var(--me), var(--me)); 
            color: #fff;
        }
        
        .bubble.voice-bubble {
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 320px;
        }
        .voice-bubble audio {
            width: 100%;
            filter: invert(1) sepia(1) saturate(5) hue-rotate(170deg);
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .audio-controls .small {
            color: var(--muted);
            font-size: 11px;
        }
        .btn-speed {
            background: var(--glass);
            border: 0;
            color: var(--muted);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            cursor: pointer;
            margin-right: auto;
        }
        .btn-speed:hover {
            background: var(--accent);
            color: #012;
            font-weight: bold;
        }


        .bubble-wrapper {
            display: flex;
            flex-direction: column;
        }
        .bubble-wrapper.me {
             align-items: flex-end;
        }

        .meta-time {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .bubble-wrapper.me .meta-time {
            justify-content: flex-end;
        }
        
        .msg-status svg {
            width: 16px;
            height: 16px;
        }
        .msg-status .icon-sent { fill: var(--muted); }
        .msg-status .icon-delivered { fill: var(--muted); }
        .msg-status .icon-read { fill: #53bdeb; }
        
        html.light-mode .bubble-wrapper.me .msg-status .icon-read {
            fill: #53bdeb; 
        }


        .input-area {
            padding: 12px;
            border-top: 1px solid var(--glass); 
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            background: var(--panel); 
        }

        .input-area textarea {
            flex: 1;
            min-height: 44px;
            padding: 12px;
            border-radius: 10px;
            border: 0;
            background: var(--glass);
            resize: none;
            color: inherit;
            font-family: var(--font-family);
            font-size: 15px;
        }

        .btn {
            padding: 10px 12px;
            border-radius: 10px;
            border: 0;
            background: var(--accent);
            color: #012;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-icon {
            padding: 0;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .btn-icon svg {
            width: 24px;
            height: 24px;
            fill: white; 
        }
        .btn-icon#sendBtn svg,
        #recording-ui .btn-icon#sendRecBtn svg {
             fill: var(--accent);
        }
        
        .btn-danger {
            background: #a42626;
            color: white;
        }

        .small {
            font-size: 13px;
            color: var(--muted);
        }

        .attachment-preview {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }

        .thumb {
            width: 72px;
            height: 72px;
            border-radius: 8px;
            overflow: hidden;
            background: #0a1220;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        html.light-mode .thumb {
            background: var(--glass);
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #recording-ui {
            padding: 12px;
            border-top: 1px solid var(--glass);
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--panel);
        }
        #recording-ui .icon-record {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e63946;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        #recording-ui span {
            font-size: 14px;
            color: var(--muted);
        }
        #recording-ui .btn-icon {
            margin-left: auto;
        }


        /* responsive -- تعديل منطق التجاوب للهاتف -- */
        @media(max-width: 900px) {
            /* تم نقل تنسيقات .app للهاتف إلى الأعلى (الأساس) */

            /* هذا المنطق يبقى كما هو (إظهار وإخفاء) */
            .sidebar {
                display: flex;
            }
            .chat {
                display: none;
            }
            .app.chat-active .sidebar {
                display: none;
            }
            .app.chat-active .chat {
                display: flex;
            }
            
            .btn-back {
                display: flex;
            }
            
            .chat-header .controls {
                display: none;
            }
        }

        /* helper small UI */
        .status {
            font-size: 13px;
            color: var(--muted);
        }

        .controls {
            display: flex;
            gap: 8px;
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            background: #06202a;
            padding: 10px 14px;
            border-radius: 8px;
            color: var(--muted);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
            z-index: 100;
        }
        html.light-mode .toast {
            background: #333;
            color: #f0f0f0;
        }
    </style>
</head>

<body>
    <svg width="0" height="0" style="position:absolute">
        <defs>
            <symbol id="icon-send" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </symbol>
            <symbol id="icon-mic" viewBox="0 0 24 24">
                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/>
            </symbol>
            <symbol id="icon-attach" viewBox="0 0 24 24">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v11.5c0 2.76 2.24 5 5 5s5-2.24 5-5V6h-1.5z"/>
            </symbol>
            <symbol id="icon-trash" viewBox="0 0 24 24">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </symbol>
            <symbol id="icon-sent" viewBox="0 0 24 24">
                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
            </symbol>
            <symbol id="icon-delivered" viewBox="0 0 24 24">
                <path d="M0 0h24v24H0z" fill="none"/><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/>
            </symbol>
            <symbol id="icon-back" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </symbol>
            <symbol id="icon-moon" viewBox="0 0 24 24">
                <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.31 0-6-2.69-6-6 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" fill="currentColor"/>
            A            </symbol>
            <symbol id="icon-sun" viewBox="0 0 24 24">
                <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM12 9c1.65 0 3 1.35 3 3s-1.35 3-3 3-3-1.35-3-3 1.35-3 3-3zM1 11h3v2H1v-2zm19 0h3v2h-3v-2zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.55 5.76 5.67 3.64l1.41 1.41L5 7.17 3.55 5.76zm14.14 14.14 1.41 1.41 2.12-2.12-1.41-1.41-2.12 2.12zm.71-11.31-1.41 1.41 2.12 2.12 1.41-1.41-2.12-2.12zM5.67 20.36l1.41-1.41-2.12-2.12-1.41 1.41 2.12 2.12z" fill="currentColor"/>
            </symbol>
        </defs>
    </svg>

    <div class="app" role="application" id="appContainer">
        <aside class="sidebar" aria-label="قائمة جهات الاتصال">
            <div class="brand">
                <div class="logo">T</div>
                <div style="flex: 1;">
                    <h1>Tcup</h1>
                </div>
                <button class="btn btn-icon" id="themeToggleBtn" title="تبديل الوضع">
                    <svg id="theme-icon-sun" style="display:none;"><use href="#icon-sun"></use></svg>
                    <svg id="theme-icon-moon" style="display:block;"><use href="#icon-moon"></use></svg>
                </button>
            </div>

            <div class="search">
                <input id="searchInput" placeholder="ابحث عن جهة اتصال أو رسالة...">
                <button id="newChatBtn" title="محادثة جديدة">+</button>
            </div>

            <div class="contacts" id="contactsList" aria-live="polite"></div>
        </aside>

        <main class="chat" aria-label="نافذة المحادثة">
            <header class="chat-header">
                <button class="btn btn-icon btn-back" id="backBtn" title="رجوع">
                    <svg><use href="#icon-back"></use></svg> 
                </button>
                <div class="avatar" id="chatAvatar"></div>
                <div style="flex:1">
                    <div id="chatName" style="font-weight:700">اختر محادثة</div>
                    <div class="status" id="chatStatus">خارج الخدمة</div>
                </div>

                <div class="controls">
                    <button class="btn" id="exportBtn">حفظ النسخة</button>
                    <button class="btn btn-danger" id="deleteContactBtn">حذف</button>
                    <button class="btn" id="clearBtn">مسح كلي</button>
                </div>
            </header>

            <section class="chat-main" id="chatMain">
                <div class="messages" id="messages"></div>
            </section>
            
            <div class="input-area" id="inputArea">
                <input type="file" id="attachInput" accept="image/*" style="display:none">
                <button class="btn btn-icon" id="attachBtn" title="ارفاق صورة">
                    <svg><use href="#icon-attach"></use></svg>
                </button>
                
                <textarea id="inputMsg" placeholder="اكتب رسالة..." aria-label="نص الرسالة"></textarea>
                
                <button class="btn btn-icon" id="sendBtn" title="ارسال">
                    <svg id="send-icon-svg" style="display:none;"><use href="#icon-send"></use></svg>
                    <svg id="mic-icon-svg" style="display:block;"><use href="#icon-mic"></use></svg>
                </button>
            </div>
            
            <div id="recording-ui" style="display:none;">
                <button class="btn btn-icon btn-danger" id="cancelRecBtn" title="إلغاء">
                    <svg><use href="#icon-trash"></use></svg>
                </button>
                <div class="icon-record"></div>
                <span id="recTimer">00:00</span>
                <span style="flex: 1; color: var(--muted); margin-right: 10px;">جاري التسجيل...</span>
                <button class="btn btn-icon" id="sendRecBtn" title="إرسال التسجيل">
                    <svg style="fill: var(--accent);"><use href="#icon-send"></use></svg>
                </button>
            </div>

            <div style="padding:0 16px 12px" id="attachPreviewContainer"></div>
        </main>
    </div>

    <div id="toast" class="toast" style="display:none"></div>

    <script>
        // ====== بيانات أولية ونماذج ======
        const STORAGE_KEY = 'Tcup-data-v1';
        const THEME_KEY = 'Tcup-theme'; 
        const sampleContacts = [
            { id: 'c1', name: 'محمد', bio: 'زميل دراسة', avatarText: 'م', online: true },
            { id: 'c2', name: 'د. أحمد', bio: 'مشرف المشروع', avatarText: 'أ', online: false },
            { id: 'c3', name: 'يوسف', bio: 'صديق الطفولة', avatarText: 'ي', online: true },
        ];

        // ====== حالة التطبيق ======
        let state = {
            contacts: [],
            conversations: {},
            current: null,
            attachments: [],
        };
        
        // ====== متغيرات التسجيل الصوتي ======
        let recInterval;
        let mediaRecorder;
        let audioChunks = [];
        let isCancelled = false;
        
        // ====== أدوات مساعدة ======
        function nowTs() { return new Date().toISOString() }
        function timeLabel(ts) {
            const d = new Date(ts);
            return d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        function saveState() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state:", e);
                showToast("خطأ: مساحة التخزين ممتلئة. لا يمكن حفظ الرسائل.");
            }
        }

        function loadState() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) {
                try {
                    state = JSON.parse(raw);
                    state.contacts = state.contacts || [];
                    state.conversations = state.conversations || {};
                    state.attachments = [];
                } catch (e) {
                    console.error(e);
                    initDefault();
                }
            } else {
                initDefault();
            }
        }

        function initDefault() {
            state.contacts = sampleContacts;
            state.conversations = {
                'c1': [{ id: 'm1', from: 'c1', text: 'مرحباً بك في Tcup!', ts: nowTs(), status: 'delivered' }],
                'c2': [],
                'c3': [],
            };
            state.current = null;
            saveState();
        }

        // ====== أيقونات حالة الرسالة ======
        function getStatusIcon(status) {
            if (status === 'read') {
                return `<span class="msg-status"><svg class="icon-read"><use href="#icon-delivered"></use></svg></span>`;
            }
            if (status === 'delivered') {
                return `<span class="msg-status"><svg class="icon-delivered"><use href="#icon-delivered"></use></svg></span>`;
            }
            if (status === 'sent') {
                return `<span class="msg-status"><svg class="icon-sent"><use href="#icon-sent"></use></svg></span>`;
            }
            return '';
        }


        // ====== تحديث UI ======
        const htmlEl = document.documentElement; 
        const appContainer = document.getElementById('appContainer');
        const backBtn = document.getElementById('backBtn');
        const contactsList = document.getElementById('contactsList');
        const messagesEl = document.getElementById('messages');
        const chatName = document.getElementById('chatName');
        const chatStatus = document.getElementById('chatStatus');
        const chatAvatar = document.getElementById('chatAvatar');
        const inputMsg = document.getElementById('inputMsg');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const attachInput = document.getElementById('attachInput');
        const attachPreviewContainer = document.getElementById('attachPreviewContainer');
        const sendIcon = document.getElementById('send-icon-svg');
        const micIcon = document.getElementById('mic-icon-svg');
        const inputArea = document.getElementById('inputArea');
        const recordingUI = document.getElementById('recording-ui');
        const cancelRecBtn = document.getElementById('cancelRecBtn');
        const sendRecBtn = document.getElementById('sendRecBtn');
        const recTimer = document.getElementById('recTimer');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIconSun = document.getElementById('theme-icon-sun');
        const themeIconMoon = document.getElementById('theme-icon-moon');


        function renderContacts(filter = "") {
            contactsList.innerHTML = "";
            const items = state.contacts.filter(c =>
                (c.name + '' + c.bio + '' + (state.conversations[c.id] || []).slice(-1)[0]?.text || "")
                .toLowerCase().includes(filter.toLowerCase())
            );
            
            if (items.length === 0) {
                contactsList.innerHTML = `<div class="small" style="text-align:center;padding:20px;">لا توجد نتائج</div>`;
            }

            items.forEach(c => {
                const lastMsg = (state.conversations[c.id] || []).slice(-1)[0];
                const el = document.createElement('div');
                el.className = 'contact' + (c.id === state.current ? ' active' : '');
                el.tabIndex = 0;
                let lastMsgText = c.bio;
                if(lastMsg) {
                    lastMsgText = lastMsg.type === 'voice' ? 'رسالة صوتية' : (lastMsg.type === 'image' ? 'صورة' : lastMsg.text);
                }
                el.innerHTML = `
                    <div class="avatar">${c.avatarText}</div>
                    <div class="meta">
                        <div class="name">${c.name}</div>
                        <div class="last">${lastMsgText}</div>
                    </div>`;
                el.addEventListener('click', () => { openChat(c.id) });
                contactsList.appendChild(el);
            });
        }

        function renderChat() {
            messagesEl.innerHTML = "";
            if (!state.current) {
                chatName.textContent = 'اختر محادثة';
                chatStatus.textContent = 'خارج الخدمة';
                chatAvatar.textContent = '?';
                document.getElementById('inputArea').style.display = 'none';
                return;
            }
            
            document.getElementById('inputArea').style.display = 'flex';
            const contact = state.contacts.find(x => x.id === state.current);
            if (!contact) {
                 state.current = null;
                 renderChat();
                 return;
            }

            chatName.textContent = contact.name;
            chatStatus.textContent = contact.online ? 'متصل' : 'غير متصل';
            chatAvatar.textContent = contact.avatarText;

            const conv = state.conversations[state.current] || [];
            
            if (conv.length === 0) {
                messagesEl.innerHTML = `<div class="small" style="text-align:center;padding:20px;">ابدأ المحادثة الآن</div>`;
            }

            conv.forEach(m => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bubble-wrapper' + (m.from === 'me' ? ' me' : '');
                
                const b = document.createElement('div');
                b.className = 'bubble' + (m.from === 'me' ? ' me' : '');

                if (m.type === 'image') {
                    b.innerHTML = `
                        <div style="max-width:360px;border-radius:8px;overflow:hidden">
                            <img src="${m.src}" style="width:100%;display:block;border-radius:8px" />
                        </div>`;
                } else if (m.type === 'voice') {
                    b.classList.add('voice-bubble');
                    const audioId = 'audio-' + m.id;
                    b.innerHTML = `
                        <audio id="${audioId}" src="${m.src}" controls></audio>
                        <div class="audio-controls">
                            <span class="small">${m.duration || '00:00'}</span>
                            <button class="btn-speed" data-target="${audioId}" data-speed="1">1x</button>
                            <button class="btn-speed" data-target="${audioId}" data-speed="1.5">1.5x</button>
                            <button class="btn-speed" data-target="${audioId}" data-speed="2">2x</button>
                        </div>
                    `;
                } else {
                    b.textContent = m.text;
                }

                const time = document.createElement('div');
                time.className = 'meta-time';
                time.textContent = timeLabel(m.ts);
                
                if (m.from === 'me') {
                    time.innerHTML = getStatusIcon(m.status) + time.innerHTML;
                }
                
                wrapper.appendChild(b);
                wrapper.appendChild(time);
                messagesEl.appendChild(wrapper);
            });

            const chatMain = document.getElementById('chatMain');
            chatMain.scrollTop = chatMain.scrollHeight;
        }

        function openChat(id) {
            state.current = id;
            saveState();
            renderChat();
            renderContacts(document.getElementById('searchInput').value);
            
            appContainer.classList.add('chat-active');
        }

        // ====== إرسال رسالة ======
        function sendMessage() {
            const text = inputMsg.value.trim();
            if (!text && state.attachments.length === 0) return showToast('اضف نص او مرفق اولا');
            if (!state.current) return showToast('اختر محادثة أولاً');

            const conv = state.conversations[state.current] || [];
            state.conversations[state.current] = conv;

            state.attachments.forEach(att => {
                conv.push({
                    id: 'm-' + Math.random().toString(36).slice(2, 9),
                    from: 'me', type: 'image', src: att, ts: nowTs(), status: 'sent'
                });
            });

            if (text) {
                conv.push({
                    id: 'm-' + Math.random().toString(36).slice(2, 9),
                    from: 'me', text, ts: nowTs(), status: 'sent'
                });
            }

            inputMsg.value = "";
            state.attachments = [];
            attachPreviewContainer.innerHTML = "";
            toggleSendButton();

            saveState();
            renderChat();
            renderContacts(document.getElementById('searchInput').value);

            setTimeout(() => {
                const itemsToDeliver = conv.filter(m => m.from === 'me' && m.status === 'sent');
                itemsToDeliver.forEach(m => m.status = 'delivered');
                saveState();
                renderChat();
            }, 900);

            setTimeout(() => {
                const contact = state.contacts.find(c => c.id === state.current);
                if (contact && text) {
                    const reply = {
                        id: 'm-' + Math.random().toString(36).slice(2, 9),
                        from: contact.id,
                        text: `تم استلام الرسالة - ${text.slice(0, 40)}`,
                        ts: nowTs(),
                        status: 'delivered'
                    };
                    state.conversations[state.current].push(reply);
                    saveState();
                    renderChat();
                    renderContacts(document.getElementById('searchInput').value);
                }
            }, 1600);
        }

        // ====== الرسائل الصوتية (حقيقي) ======
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isCancelled = false;
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                    
                    if (isCancelled) {
                        resetRecordingUI();
                        return;
                    }

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64Audio = reader.result;
                        sendVoiceMessage(base64Audio, recTimer.textContent);
                    };
                    reader.readAsDataURL(audioBlob);
                };

                mediaRecorder.start();
                inputArea.style.display = 'none';
                recordingUI.style.display = 'flex';
                
                let seconds = 0;
                recTimer.textContent = '00:00';
                recInterval = setInterval(() => {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    recTimer.textContent = `${mins}:${secs}`;
                }, 1000);

            } catch (err) {
                console.error("Permission denied or error:", err);
                showToast("لم يتم منح إذن الوصول إلى الميكروفون.");
            }
        }
        
        function resetRecordingUI() {
            inputArea.style.display = 'flex';
            recordingUI.style.display = 'none';
            clearInterval(recInterval);
        }

        function sendVoiceMessage(audioSrc, duration) {
            if (!state.current) return showToast('اختر محادثة أولاً');
            
            const conv = state.conversations[state.current] || [];
            state.conversations[state.current] = conv;
            
            conv.push({
                id: 'm-' + Math.random().toString(36).slice(2, 9),
                from: 'me',
                type: 'voice',
                src: audioSrc,
                duration: duration,
                ts: nowTs(),
                status: 'sent'
            });
            
            resetRecordingUI();
            saveState();
            renderChat();
            renderContacts(document.getElementById('searchInput').value);
            
             setTimeout(() => {
                const last = conv[conv.length - 1];
                if (last && last.from === 'me' && last.status === 'sent') last.status = 'delivered';
                saveState();
                renderChat();
            }, 900);
        }

        // ====== تبديل زر الإرسال / الميكروفون ======
        function toggleSendButton() {
            if (inputMsg.value.trim().length > 0) {
                sendIcon.style.display = 'block';
                micIcon.style.display = 'none';
            } else {
                sendIcon.style.display = 'none';
                micIcon.style.display = 'block';
            }
        }


        // ====== Attachments ======
        attachBtn.addEventListener('click', () => attachInput.click());
        attachInput.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
                state.attachments.push(reader.result);
                renderAttachmentsPreview();
            }
            reader.readAsDataURL(f);
        });

        function renderAttachmentsPreview() {
            attachPreviewContainer.innerHTML = "";
            if (state.attachments.length === 0) return;

            const wrap = document.createElement('div');
            wrap.className = 'attachment-preview';
            state.attachments.forEach((src, idx) => {
                const t = document.createElement('div');
                t.className = 'thumb';
                t.innerHTML = `<img src="${src}" />`;
                wrap.appendChild(t);
            });

            const clearBtn = document.createElement('button');
            clearBtn.className = 'btn btn-danger';
            clearBtn.textContent = 'مسح المرفقات';
            clearBtn.addEventListener('click', () => {
                state.attachments = [];
                renderAttachmentsPreview();
            });

            attachPreviewContainer.appendChild(wrap);
            attachPreviewContainer.appendChild(clearBtn);
        }

        // ====== إدارة جهات الاتصال (جديد, حذف) ======
        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderContacts(e.target.value);
        });

        document.getElementById('newChatBtn').addEventListener('click', () => {
            const name = prompt('اسم جهة الاتصال الجديدة:');
            if (!name) return;
            const bio = prompt('العلاقة (مثل: زميل عمل، صديق):', 'جهة اتصال جديدة');

            const id = 'c-' + Math.random().toString(36).slice(2, 8);
            const item = {
                id,
                name,
                bio: (bio || 'جهة اتصال جديدة'),
                avatarText: (name.trim()[0] || '؟').toUpperCase(),
                online: false
            };
            state.contacts.unshift(item);
            state.conversations[item.id] = [];
            saveState();
            renderContacts();
            openChat(item.id);
        });
        
        document.getElementById('deleteContactBtn').addEventListener('click', () => {
            if (!state.current) return showToast('اختر محادثة لحذفها');
            
            const contact = state.contacts.find(c => c.id === state.current);
            if (confirm(`هل أنت متأكد من حذف ${contact.name}؟ سيتم حذف جميع المحادثات معه.`)) {
                deleteContact(state.current);
            }
        });

        function deleteContact(id) {
            state.contacts = state.contacts.filter(c => c.id !== id);
            delete state.conversations[id];
            state.current = null;
            saveState();
            renderContacts();
            renderChat();
            showToast('تم حذف جهة الاتصال');
        }

        // ====== تصدير ومسح ======
        document.getElementById('exportBtn').addEventListener('click', () => {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Tcup-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('هل أنت متأكد أنك تريد مسح كل المحادثات والبيانات؟')) {
                localStorage.removeItem(STORAGE_KEY);
                initDefault();
                renderContacts();
                renderChat();
                showToast('تم مسح جميع البيانات');
            }
        });

        // ====== اختصارات ولوحة المفاتيح ======
        sendBtn.addEventListener('click', async () => {
            if (inputMsg.value.trim().length > 0) {
                sendMessage();
            } else {
                await startRecording();
            }
        });
        
        inputMsg.addEventListener('input', toggleSendButton);

        inputMsg.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (inputMsg.value.trim().length > 0) {
                    sendMessage();
                }
            }
        });
        
        cancelRecBtn.addEventListener('click', () => {
            isCancelled = true;
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            resetRecordingUI();
        });

        sendRecBtn.addEventListener('click', () => {
            isCancelled = false;
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        });
        
        backBtn.addEventListener('click', () => {
            appContainer.classList.remove('chat-active');
            state.current = null;
            renderContacts();
        });

        // ====== التحكم في سرعة الصوت ======
        messagesEl.addEventListener('click', e => {
            if (e.target.classList.contains('btn-speed')) {
                const targetId = e.target.dataset.target;
                const speed = parseFloat(e.target.dataset.speed);
                const audioEl = document.getElementById(targetId);
                if (audioEl) {
                    audioEl.playbackRate = speed;
                    const parent = e.target.parentElement;
                    parent.querySelectorAll('.btn-speed').forEach(btn => btn.style.fontWeight = 'normal');
                    e.target.style.fontWeight = 'bold';
                }
            }
        });

        // ====== small utilities ======
        function showToast(t) {
            const toast = document.getElementById('toast');
            toast.textContent = t;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2500);
        }

        // ====== منطق تبديل الوضع ======
        function toggleTheme() {
            const isLight = htmlEl.classList.toggle('light-mode');
            if (isLight) {
                themeIconSun.style.display = 'block';
                themeIconMoon.style.display = 'none';
                localStorage.setItem(THEME_KEY, 'light');
            } else {
                themeIconSun.style.display = 'none';
                themeIconMoon.style.display = 'block';
                localStorage.setItem(THEME_KEY, 'dark');
            }
        }
        
        function initThemeIcon() {
             const savedTheme = localStorage.getItem(THEME_KEY);
             if (savedTheme === 'light') {
                themeIconSun.style.display = 'block';
                themeIconMoon.style.display = 'none';
            } else {
                themeIconSun.style.display = 'none';
                themeIconMoon.style.display = 'block';
            }
        }
        
        themeToggleBtn.addEventListener('click', toggleTheme);
        // ===================================


        // ====== init ======
        initThemeIcon(); 
        loadState();
        renderContacts();
        renderChat();

        // expose for debugging
        window.tcup = state;
    </script>
</body>
</html>
